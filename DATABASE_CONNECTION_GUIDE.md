# 数据库连接配置指南

## 一、当前配置问题

从您提供的截图可以看到，您的数据库连接配置存在以下问题：

1. **连接字符串格式错误**：当前格式缺少冒号和斜杠，正确格式应为：
   ```
   postgresql://用户名:密码@主机:端口/数据库名
   ```

2. **使用了SQL查询节点而非向量查询节点**：对于内容相似度匹配，您应该使用「向量数据库查询」节点而非「SQL查询」节点。

## 二、正确的数据库连接配置

### 1. 连接Docker中的PostgreSQL数据库

根据您的Docker容器信息，正确的连接参数应为：

- **数据库类型**：PostgreSQL
- **数据库地址**：172.21.0.4（docker-db-1容器的IP地址）
- **端口**：5432
- **用户名**：postgres（默认用户名）
- **密码**：postgres（默认密码，或根据实际配置）
- **数据库名**：dify（或您实际使用的数据库名）

### 2. 正确的连接字符串格式

```
postgresql://postgres:postgres@172.21.0.4:5432/dify
```

### 3. 在Dify界面中的配置

1. **数据库地址**：172.21.0.4
2. **端口**：5432
3. **用户名**：postgres
4. **密码**：postgres
5. **数据库名**：dify

## 三、向量数据库查询节点配置

对于内容相似度匹配，您应该使用「向量数据库查询」节点，而非「SQL查询」节点。配置步骤：

1. **添加「向量数据库查询」节点**：从节点列表中选择此节点
2. **配置数据库连接**：使用上述正确的连接参数
3. **配置查询参数**：
   - 表名：contents
   - 向量字段：embedding
   - 匹配字段：content
   - 相似度阈值：0.8（可根据需要调整）
   - 返回结果数：5

## 四、验证数据库连接

### 1. 测试数据库连接

在终端中运行以下命令，验证数据库是否可以正常连接：

```bash
docker exec -it docker-db-1 psql -U postgres -d dify
```

### 2. 验证contents表是否存在

在数据库连接成功后，运行以下命令：

```sql
\d contents
```

如果表存在，您将看到表结构；如果不存在，您需要先创建该表。

## 五、修正后的Chatflow配置

1. **删除现有的SQL查询节点**
2. **添加向量数据库查询节点**
3. **配置正确的数据库连接参数**
4. **配置向量查询参数**
5. **连接节点**：用户输入 → LLM → 向量数据库查询 → 输出

## 六、注意事项

1. 确保PostgreSQL数据库已启用pgvector扩展（如果使用向量类型）
2. 确保contents表中的embedding字段已正确填充向量值
3. 使用向量数据库查询节点而非SQL查询节点进行相似度匹配
4. 调整相似度阈值以获得更准确的结果

## 七、测试连接

完成配置后，点击「测试连接」按钮验证数据库连接是否成功。如果连接失败，请检查：

1. 数据库地址和端口是否正确
2. 用户名和密码是否正确
3. 数据库名是否正确
4. 数据库是否允许远程连接
5. 防火墙是否允许连接