# 全能管家AI智能助理

基于Dify Agent实现的全能管家AI智能助理，提供服务笔记查询、订单管理等功能。

## 核心功能

### 场景一：咨询类 - 查询笔记/知识
- 用户可以查询服务笔记和知识库内容
- 支持按相似度匹配相关笔记
- 提供查看详情和返回按钮

### 场景二：查询类 - 查询订单/人员
- 用户可以查询订单列表
- 显示订单ID、服务时间、服务类型、服务人员和状态
- 支持后续的订单修改和取消操作

### 场景三：操作类 - 修改/取消订单
- 支持修改订单时间
- 支持取消订单
- 所有操作类场景均需二次确认
- 提供友好的成功/失败反馈

## 配置文件说明

### 1. intent_model.yml
意图识别模型配置，定义了智能体支持的意图和实体：
- 查询笔记/知识
- 查询订单/人员
- 修改订单
- 取消订单

### 2. api_config.yml
业务API和知识库集成配置：
- 配置了查询订单、检查订单可修改性、修改订单、取消订单等API
- 配置了服务笔记知识库的连接参数

### 3. confirmation_config.yml
操作类场景二次确认机制配置：
- 定义了修改订单和取消订单的确认流程
- 包括确认消息模板、执行逻辑和取消逻辑
- 定义了状态管理流程

### 4. agent_config.yml
Dify Agent完整配置：
- 整合了所有子配置文件
- 定义了决策中心的规则
- 配置了对话管理、状态管理、响应模板等

## 部署说明

### 环境变量

需要设置以下环境变量：

```bash
export HAOKANG_API_BASE_URL="https://api.haokang.com"  # API基础URL
export HAOKANG_API_KEY="your-api-key"  # API密钥
export OPENAI_API_KEY="your-openai-key"  # OpenAI API密钥
```

### 部署步骤

1. 将所有配置文件上传到Dify平台
2. 在Dify平台创建新的Agent
3. 选择"基于配置文件创建"
4. 上传agent_config.yml文件
5. 配置环境变量
6. 测试智能体功能
7. 发布智能体

## 测试场景

### 场景一：查询服务笔记

```
用户：上次服务的笔记是什么？
智能体：正在查询您的服务笔记...
智能体：找到以下相关服务笔记：
- 服务日期: 2023-10-15
  服务人员: 张阿姨
  笔记内容: 本次服务完成了客厅、卧室的清洁，客户对服务质量满意...
  详情: [查看详情](note_123)
- 服务日期: 2023-10-01
  服务人员: 李阿姨
  笔记内容: 本次服务完成了厨房、卫生间的深度清洁，客户提出了一些建议...
  详情: [查看详情](note_124)
```

### 场景二：查询订单

```
用户：我有哪些订单？
智能体：正在查询您的订单...
智能体：为您找到以下订单：
- 订单ID：order_123
  服务时间：2023-11-01 14:00:00
  服务类型：深度清洁
  服务人员：张阿姨
  状态：已确认
- 订单ID：order_124
  服务时间：2023-11-08 14:00:00
  服务类型：日常保洁
  服务人员：李阿姨
  状态：已确认

您可以说"修改订单"或"取消订单"来管理您的订单。
```

### 场景三：修改订单

```
用户：我想修改订单order_123的时间为2023-11-02 14:00
智能体：正在检查订单可修改性...
智能体：我已为您查询到订单状态：
该订单可以修改，周六有空位。

您是否确认将订单order_123修改为2023-11-02 14:00？
[确认修改] [取消操作]

用户：确认修改
智能体：正在修改订单...
智能体：订单修改成功！新的服务时间为：2023-11-02 14:00:00
```

### 场景三：取消订单

```
用户：我想取消订单order_124
智能体：您确定要取消订单order_124吗？
取消后可能会产生相应的费用，请您确认。
[确认取消] [取消操作]

用户：确认取消
智能体：正在取消订单...
智能体：订单取消成功！
```

## 技术架构

### 核心组件

1. **用户端(App/前端)**：用户与智能体交互的界面
2. **后端(BFF/GateWay)**：处理用户请求，转发给Dify Agent
3. **Dify Agent决策中心**：根据用户意图和规则进行决策
4. **LLM大脑(意图识别)**：识别用户意图
5. **业务API(订单/排班)**：提供订单查询、修改、取消等功能
6. **知识库(服务笔记)**：存储和检索服务笔记

### 数据流

1. 用户发送消息到后端
2. 后端将消息转发给Dify Agent
3. Dify Agent调用LLM进行意图识别
4. 根据意图匹配相应的规则
5. 调用相应的工具(API或知识库)
6. 生成响应并返回给后端
7. 后端将响应返回给用户

## 监控与日志

- 支持JSON格式日志
- 日志按天轮转，保留30天
- 支持Prometheus指标监控
- 支持Jaeger分布式追踪

## 安全配置

- 支持请求频率限制(60次/分钟)
- 支持敏感词过滤
- 所有API调用使用Bearer Token认证

## 扩展建议

1. **添加更多意图**：支持更多服务场景，如预约服务、投诉建议等
2. **优化意图识别**：使用fine-tuning或few-shot learning提高意图识别准确率
3. **添加多轮对话支持**：支持更复杂的对话场景
4. **优化响应模板**：根据用户反馈优化响应内容
5. **添加情感分析**：识别用户情绪，提供更个性化的服务

## 联系方式

如有问题，请联系技术团队：
- 邮箱：tech@haokang.com
- 电话：400-123-4567

---

© 2023 在家 All Rights Reserved.